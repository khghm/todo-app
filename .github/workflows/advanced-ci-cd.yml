name: ğŸš€ Pipeline Ù¾ÛŒØ´Ø±ÙØªÙ‡

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  
  # Ø¢Ø²Ù…Ø§ÛŒØ´ Ø±ÙˆÛŒ Ú†Ù†Ø¯ Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„ Ù…Ø®ØªÙ„Ù
  test-matrix:
    name: ğŸ§ª ØªØ³Øª Ø±ÙˆÛŒ ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16, 18, 20]
    
    steps:
    - name: ğŸ  ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Ù†ØµØ¨ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“š Ù†ØµØ¨ dependencies
      run: npm ci
      
    - name: âœ… Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§
      run: npm run test:run
      
    - name: ğŸ—ï¸ Ø¢Ø²Ù…Ø§ÛŒØ´ Build
      run: npm run build
      
    - name: ğŸ“Š Ø¢Ù¾Ù„ÙˆØ¯ Coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ matrix.os }}-${{ matrix.node-version }}
        path: coverage/
        
  # Ø³Ø§Ø®Øª Ùˆ Ù¾ÙˆØ´ Docker Image
  docker-push:
    name: ğŸ³ Ø³Ø§Ø®Øª Ùˆ Ù¾ÙˆØ´ Docker
    runs-on: ubuntu-latest
    needs: test-matrix
    if: github.ref == 'refs/heads/main'  # ÙÙ‚Ø· Ø±ÙˆÛŒ main branch
    
    steps:
    - name: ğŸ  ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
      uses: actions/checkout@v4
      
    - name: ğŸ³ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ù‡ Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: ğŸ—ï¸ Ø³Ø§Ø®Øª Ùˆ Ù¾ÙˆØ´ Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
          ${{ secrets.DOCKER_USERNAME }}/todo-app:${{ github.sha }}
          
  # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ
  notify:
    name: ğŸ“¢ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ
    runs-on: ubuntu-latest
    needs: [test-matrix, docker-push]
    
    steps:
    - name: ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
      if: always()  # Ø­ØªÛŒ Ø§Ú¯Ø± fail Ø´Ø¯ Ù‡Ù… Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: '${{ job.status }}: Pipeline ${{ github.repository }}'
        to: '${{ secrets.NOTIFICATION_EMAIL }}'
        from: 'GitHub Actions <noreply@github.com>'