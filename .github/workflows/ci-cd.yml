# Ø§Ø³Ù… Ø§ÛŒÙ† Ø®Ø· ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
name: CI/CD Pipeline

# Ú©ÛŒ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ø± Ú©Ù†Ù‡ØŸ 
on:
  push:    # ÙˆÙ‚ØªÛŒ Ú©Ø¯ Ø±Ùˆ Ù…ÛŒâ€ŒÙØ±Ø³ØªÛŒ
    branches: [ main, develop ]
  pull_request:  # ÙˆÙ‚ØªÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ú©Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ø§Ø¯ØºØ§Ù… Ú©Ù†ÛŒ
    branches: [ main ]

# Ø¯Ú©Ù…Ù‡ Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
permissions:
  contents: read

# Ú©Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø±Ø¨Ø§Øª Ø¨Ø§ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
jobs:
  
  # Ú©Ø§Ø± Ø´Ù…Ø§Ø±Ù‡ Û±: Ø¢Ø²Ù…Ø§ÛŒØ´ Ú©ÛŒÙÛŒØª
  quality-check:
    name: ğŸ§ª Ø¢Ø²Ù…Ø§ÛŒØ´ Ú©ÛŒÙÛŒØª Ú©Ø¯
    runs-on: ubuntu-latest  # Ø±ÙˆÛŒ Ú†Ù‡ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±ÛŒ Ø§Ø¬Ø±Ø§ Ø¨Ø´Ù‡
    
    steps:
    # Ù‚Ø¯Ù… Û±: Ø¨Ø±Ùˆ ØªÙˆ Ø®ÙˆÙ†Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
    - name: ğŸ  ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
      uses: actions/checkout@v4
    
    # Ù‚Ø¯Ù… Û²: Node.js Ù†ØµØ¨ Ú©Ù†
    - name: ğŸ”§ Ù†ØµØ¨ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # Ù‚Ø¯Ù… Û³: Ú©ØªØ§Ø¨Ø®ÙˆÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ù†ØµØ¨ Ú©Ù†
    - name: ğŸ“š Ù†ØµØ¨ dependencies
      run: npm ci
      
    # Ù‚Ø¯Ù… Û´: ØªØ³Øª Ú©Ù† Ø¨Ø¨ÛŒÙ† Ú©Ø¯Ù‡Ø§ Ø¯Ø±Ø³ØªÙ†
    - name: âœ… Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§
      run: npm run test:run
      
    # Ù‚Ø¯Ù… Ûµ: build Ú©Ù† Ø¨Ø¨ÛŒÙ† Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø§Ø±Ù‡ ÛŒØ§ Ù†Ù‡
    - name: ğŸ—ï¸ Ø¢Ø²Ù…Ø§ÛŒØ´ Build
      run: npm run build

  # Ú©Ø§Ø± Ø´Ù…Ø§Ø±Ù‡ Û²: Ø³Ø§Ø®Øª Docker image
  docker-build:
    name: ğŸ³ Ø³Ø§Ø®Øª Docker Image
    runs-on: ubuntu-latest
    needs: quality-check  # Ø§ÙˆÙ„ Ú©Ø§Ø± Ø´Ù…Ø§Ø±Ù‡ Û± Ø¨Ø§ÛŒØ¯ ØªÙ…ÙˆÙ… Ø¨Ø´Ù‡
    
    steps:
    # Ù‚Ø¯Ù… Û±: Ø¨Ø±Ùˆ ØªÙˆ Ø®ÙˆÙ†Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
    - name: ğŸ  ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
      uses: actions/checkout@v4
      
    # Ù‚Ø¯Ù… Û²: Docker Ø±Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù†
    - name: ğŸ³ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Docker
      uses: docker/setup-buildx-action@v3
      
    # Ù‚Ø¯Ù… Û³: Docker image Ø¨Ø³Ø§Ø²
    - name: ğŸ—ï¸ Ø³Ø§Ø®Øª Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false  # Ù‡Ù†ÙˆØ² ØªÙˆ Docker Hub Ù†Ø°Ø§Ø±
        tags: todo-app:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Ú©Ø§Ø± Ø´Ù…Ø§Ø±Ù‡ Û³: Ø§Ø³Ú©Ù† Ø§Ù…Ù†ÛŒØªÛŒ
  security-scan:
    name: ğŸ”’ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: ğŸ  ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Ù†ØµØ¨ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“š Ù†ØµØ¨ dependencies
      run: npm ci
      
    # Ø§Ø³Ú©Ù† Ú©Ø±Ø¯Ù† dependencyÙ‡Ø§ Ø¨Ø¨ÛŒÙ† Ù…Ø´Ú©Ù„ Ø§Ù…Ù†ÛŒØªÛŒ Ø¯Ø§Ø±Ù† ÛŒØ§ Ù†Ù‡
    - name: ğŸ” Ø§Ø³Ú©Ù† Ø§Ù…Ù†ÛŒØªÛŒ
      run: npm audit --audit-level=high